pipeline {
    agent any
    
    stages {
        stage('csm') {
            steps {

                echo 'Hello World'
                sh "pwd"
                sh '''git --version
                    DIR="SalesforceCICD"
                    if [ -d "$DIR" ]; then
                      cd SalesforceCICD
                      git pull
                    else  
                      git clone https://github.com/ImRaj90/SalesforceCICD.git
                      cd SalesforceCICD
                    fi
                    git checkout ${BranchName}
                    git branch
                    '''
                    }
            }
        stage('authenitcating') {
            

            steps {
//                withCredentials([usernamePassword(credentialsId: 'b3acfe60-dfa8-4a45-9685-921569451360', passwordVariable: 'sbpassword', usernameVariable: 'sbusername')]) {
                // some block
withCredentials([file(credentialsId: '34618e1e-5d36-4189-8e27-0e7273bd7919', variable: 'SERVER_KEY')]) {
                sh '''
                sfdx auth:jwt:grant --clientid ${SB_CLIENTID} --jwtkeyfile ${SERVER_KEY} --username ${SB_USERNAME} --instanceurl ${SB_URL} --setalias devorg
                '''
     //              sfdx sfpowerkit:auth:login -u ${sbusername} -p ${sbpassword} -r https:/login.salesforce.com/ -a devorg

                }
            }            
        }
        stage('deltapkg') {
            steps {
                echo 'deltapkg'
                sh '''
                   ls -ltra  
                   cd SalesforceCICD
                   sfdx sfpowerkit:project:diff --revisionfrom ${CommitIDFrom} --revisionto ${CommitIDTo} --output dkg
                '''
            }
        }

        stage('checkonlydeployment') {
            steps {
                sh '''
                cd SalesforceCICD
                echo 'checkonlydeployment'
                    ls -ltra
                    cd dkg
                    ls -ltra
                    cat diff.json
                    ls -ltr
                    tree force-app/main/default
                sfdx force:source:deploy -c -p force-app -u devorg
                '''
            
            }
        }
        stage('deployment') {
            steps {
                sh '''
                    ls -ltra
                    cd dkg
                    ls -ltra
                    cat diff.json
                    ls -ltr
                    tree force-app/main/default
                sfdx force:source:deploy -c -p force-app -u devorg
                echo 'deployment'
                '''
            }
        }

    }
}
